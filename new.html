<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Kendo UI Snippet</title>

    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.2.616/styles/kendo.default-v2.min.css" />

    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2021.2.616/js/kendo.all.min.js"></script>
</head>

<body>

    <style>
        body {
            margin: 0;
            font-style: italic;
        }
        
        .k-grid {
            width: 500px;
            background-color: bisque;
        }
        
        table {
            width: 90%;
        }
        
        .k-grid td {
            text-align: center;
            vertical-align: middle;
            font-size: 12pt;
            /* background-color: blanchedalmond; */
            font-weight: bold;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        }
        
        td {
            width: 25%;
            position: relative;
        }
        
        td:after {
            content: '';
            display: block;
            margin-top: 100%;
        }
        
        td .content {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: gold;
        }
        
        .k-master-row {
            /* background-color: brown;*/
            color: rgb(191, 211, 154);
        }
        
        .k-alt {
            background-color: burlywood;
        }
        
        .two {
            background-color: #eee4da;
        }
        
        .four {
            background-color: #eee1c9;
        }
        
        .eight {
            background-color: #f3b27a;
        }
        
        .sixteen {
            background-color: #f69664;
        }
        
        .thirty_two {
            background-color: #f77c5f;
        }
        
        .sixty_four {
            background-color: #f75f3b;
        }
        
        .one_hundred_twenty_eight {
            background-color: #edd073;
        }
        
        .two_hundred_fifty_six {
            background-color: #eff14f;
        }
        /* take care of portrait orientation or ratio */
        
        html {
            height: 100%;
            display: flex;
        }
        
        body {
            margin: auto;
        }
        
        div.k-grid-header {
            height: 0;
            border-bottom-width: 0;
            display: none;
            overflow: hidden;
        }
        
        .k-grid-header {
            padding: 0 !important;
        }
        
        .k-grid-content {
            overflow-y: visible;
        }
    </style>
    <div id="gameArea" class="area">

    </div>
    <div id="dialog" hidden="true"></div>

    <div id="gridSource"></div>
    <div id="MessageShow"></div>
    <div id="Popup"></div>
    <button id="ResetBtn">Reset</button>

    <script id="javascriptTemplate" type="text/x-kendo-template">
        #for(var t=0;t
        <coordsValues[0];t++) {# if(getNumberClass(coordsValues[t])=='two' ){# <div class=two>#=value[0]#</div>#} else {#
            <div>1233
                <div> #}# #}# #}#


    </script>
    <script>
        var colorClassDict = {
            '2': 'two',
            '4': 'four',
            '8': 'eight',
            '16': 'sixteen',
            '32': 'thirty_two',
            '64': 'sixty_four',
            '128': 'one_hundred_twenty_eight',
            '256': 'two_hundred_fifty_six',
            '512': 'fife_hundred_twelve',
            '1024': 'one_thousand_twenty_four',
            '2048': 'two_thousand_fourty_eight'
        };
        var leftCode = 37;
        var upCode = 38;
        var rightCode = 39;
        var downCode = 40;
        var i = 0;
        var beginValue = 2;
        var arrOfCoords = [
            []

        ];

        var row = {
            first: 0,
            second: 0,
            third: 0,
            fourth: 0,
            //  fifth:0
        }
        var table = row[4];
        var jsonData = "";
        var startData = init(table);
        var coordsValues = [
            [2, 2, 2, ""],
            [2, "", "", ""],
            ["", "", "", ""],
            ["", "", "", ""]
        ];
        var stringData = JSON.stringify(coordsValues);

        var dataByRow = [{
                "first": "2",
                "second": "",
                "third": "2",
                "fourth": ""
            }, {
                "first": "",
                "second": "",
                "third": "",
                "fourth": ""
            }, {
                "first": "",
                "second": "",
                "third": "",
                "fourth": ""
            }, {
                "first": "",
                "second": "",
                "third": "",
                "fourth": ""
            }

        ]
        var tempVar = arrObjInit(dataByRow);
        $(document).ready(function() {
            var gameGrid;
            $(this).keydown(function(e) {
                switch (e.keyCode) {

                    case rightCode:
                        moveRight(coordsValues);
                        coordsValues = seedAtRandomPos(coordsValues);
                        gameGrid.dataSource.read();
                        gameGrid.refresh();
                        getResult(coordsValues);
                        // tryMoveRight(coordsValues);
                        $("#dialog").kendoWindow({

                            position: {
                                top: currentTop,
                                left: "90%"
                            }
                        });
                        //   alert(  seedAtRandomPos(coordsValues));
                        break;
                    case leftCode:
                        moveLeft(coordsValues)
                        coordsValues = seedAtRandomPos(coordsValues);
                        getResult(coordsValues);
                        gameGrid.dataSource.read();
                        gameGrid.refresh();
                        $("#dialog").kendoWindow({
                            position: {
                                top: currentTop,
                                left: "1%"
                            }
                        });
                        break;
                    case upCode:
                        moveUp(coordsValues)
                        coordsValues = seedAtRandomPos(coordsValues);
                        getResult(coordsValues);
                        gameGrid.dataSource.read();
                        gameGrid.refresh();
                        $("#dialog").kendoWindow({
                            position: {
                                top: "0%",
                                left: currentLeft
                            }
                        });
                        break;
                    case downCode:
                        moveDown(coordsValues);
                        coordsValues = seedAtRandomPos(coordsValues);
                        getResult(coordsValues);
                        gameGrid.dataSource.read();
                        gameGrid.refresh();
                        $("#dialog").kendoWindow({
                            position: {
                                top: "85%",
                                left: currentLeft
                            }
                        });
                        break;

                }

            });

            var win = $("#dialog").data("kendoWindow");
            var position = win.wrapper.offset();
            var currentTop = position.top;
            var currentLeft = position.left;
            var dataSourceNew = new kendo.data.DataSource({

                transport: {
                    read: function(e) {
                        // On success.
                        e.success(coordsValues);
                        // On failure.
                        //e.error("XHR response", "status code", "error message");
                    },

                    update: function(e) {
                        // Locate item in original datasource and update it.
                        coordsValues = e;
                        // On success.
                        e.success();
                        // On failure.
                        e.error("XHR response", "status code", "error message");
                    }

                },
                error: function(e) {
                    // Handle data operation error.
                    alert("Status: " + e.status + "; Error message: " + e.errorThrown);
                },
                // pageSize: 10,
                batch: false,

                schema: {
                    model: {

                        fields: {
                            "[0]": {
                                type: "(string | number)"
                            },
                            "[1]": {
                                type: "(string | number)"
                            },
                            "[2]": {
                                type: "(string | number)"
                            },
                            "[3]": {
                                type: "(string | number)"
                            }
                        }
                    }
                }

            });
            //if change two-dimension array on object of arrays
            var objData = {
                first: [],
                second: [],
                third: [],
                fourth: []

            };
            var gameGrid = $("#gridSource").kendoGrid({
                dataSource: dataSourceNew,
                columns: [{
                    field: "[0]",
                    title: " ",
                    height: "120px"
                }, {
                    field: "[1]",
                    title: " ",
                    height: "120px"

                }, {
                    field: "[2]",
                    title: " ",
                    height: "120px"
                }, {
                    field: "[3]",
                    title: " ",
                    height: "120px"
                }, ],
                dataBound: function(e) {
                    var container = $("#gridSource");
                    var cells = container.find("td[role=gridcell]");

                    for (var i = 0; i < cells.length; i++) {
                        var cell = $(cells[i]);
                        var d = cell;
                        var className = getNumberClass(Number.parseInt(d.context.innerHTML));
                        cell.addClass(className);

                    }
                }
            }).data("kendoGrid");
        });

        var rowData = [];
        for (var i = 0; i < coordsValues.length; i++) {
            rowData.push({
                first: coordsValues[i][0],
                second: coordsValues[i][1],
                third: coordsValues[i][2],
                fourth: coordsValues[i][3]

            });

        }
        var jsonData = JSON.stringify(coordsValues);
        var gameMatrix = initArr(coordsValues);
        var temp = kendo.template("<div id='box'><span>#=value#</span></div> ");
        var data = {
            value: `<b>${beginValue}</b>`
        };
        var res = temp(data);
        $("#grid").kendoGrid({

            columns: [{}],
        });
        $("#dialog").kendoWindow({

        });


        $("#dialog").html(res);
        $("#newGrid").kendoGrid({
            rowTemplate: '<div id=`box`>#: name #</div>',
            dataSource: [coordsValues.toString()]

        });

        function init(r) {
            if (r !== undefined) {
                r[0].first = 2;
            }
            return r;
        }

        function initArr(a) {
            if (a !== undefined) {
                a[0][0] = 2;
            }
            return a;

        }

        function arrObjInit(obj) {
            if (obj !== undefined) {
                var indexes = [];
                var data = obj.filter(a => (a.first == "") || (a.second == "") || (a.third == "") || (a.fourth == ""));
                return data;
            }
        }

        function tryMoveRight(arr) {
            if (arr !== undefined) {
                var changes = [
                    [],
                    [],
                    [],
                    []
                ]
                for (var i = 0; i < arr.length; i++) {

                    for (var j = 1; j < arr[i].length; j++) {

                        if (arr[i][j] == arr[i][j - 1]) {
                            var temp = (arr[i][j]) * 2;
                            changes[i].push(temp);

                        } else {
                            changes[i].push(arr[i][j]);
                        }


                    }

                }
                for (var i = 0; i < arr.length; i++) {
                    for (var j = arr[i].length - 1; j >= 0; j--) {
                        if (arr[i][j] == 0) {
                            for (var c = changes[i].length - 1; c >= 0; c--)

                            {

                                arr[i][j] = changes[i][c];
                            }
                        }
                    }
                }
            }
        }

        function seedAtRandomPos(arr)

        {
            var coordsPossible = [
                []
            ];
            var curCoord = [];
            for (var i = 0; i < arr.length; i++) {
                for (var j = 0; j < arr[i].length; j++) {
                    if (arr[i][j] == "") {
                        curCoord.push(i);
                        curCoord.push(j);
                        coordsPossible.push(curCoord);
                    }
                }
            }
            var coord = Math.floor(Math.random() * coordsPossible.length);

            var tmp = coordsPossible[coord];
            var max = 0;
            for (var i = 0; i < arr.length; i++) {
                for (var j = 0; j < arr[i].length; j++) {
                    if (arr[i][j] > max) {
                        max = arr[i][j];
                    }
                }
            }
            var randomValues = [];
            for (var i = 1; i < 20; i++) {
                if (Math.pow(2, i) == max) {
                    for (var j = 1; j <= i; j++) {
                        if (j > 3) {
                            randomValues.push(Math.pow(2, j - 3));
                        } else {
                            if (!randomValues.includes(2)) {
                                randomValues.push(2);
                            }
                        }


                    }
                    break;
                }
            }
            var rnd_res = Math.floor(Math.random() * randomValues.length);
            var _i = tmp[0];
            var _j = tmp[1];
            for (var i = 0; i < arr.length; i++) {
                for (var j = 0; j < arr[i].length; j++) {
                    if (i == _i && j == _j) {
                        arr[i][j] = randomValues[rnd_res];
                    }
                }
            }
            return arr;
        }

        function moveDown(arr) {
            if (arr != null && arr !== undefined) {
                var firstColumnStepsToDown = 0;
                var secondColumnStepsToDown = 0;
                var thirdColumnStepsToDown = 0;
                var fourthColumnStepsToDown = 0;
                var columnsStepsArr = [0, 0, 0, 0];
                for (var i = arr.length - 1; i > 0; i--) {
                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] == arr[i - 1][j] && arr[i][j] != "") {
                            arr[i][j] = (arr[i][j] * 2);
                            arr[i - 1][j] = "";
                        }
                    }
                }


                for (var i = 0; i < arr.length - 1; i++) {
                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] != "" && arr[i + 1][j] == "") {
                            arr[i + 1][j] = arr[i][j];
                            arr[i][j] = "";
                            i = 0;
                            j = 0;
                        }
                    }
                }

                for (var i = arr.length - 1; i > 0; i--) {
                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] == "") {
                            columnsStepsArr[j]++;
                            continue;
                        }



                    }
                }

            }
            return arr;

        }

        function moveUp(arr) {

            if (arr != null && arr !== undefined) {
                var firstColumnStepsToDown = 0;
                var secondColumnStepsToDown = 0;
                var thirdColumnStepsToDown = 0;
                var fourthColumnStepsToDown = 0;
                var columnsStepsArr = [0, 0, 0, 0];

                for (var i = 0; i < arr.length - 1; i++) {
                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] == arr[i + 1][j] && arr[i][j] != "") {
                            arr[i][j] = (arr[i][j] * 2);
                            arr[i + 1][j] = "";
                        }
                    }
                }
                for (var i = arr.length - 1; i > 0; i--) {
                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] != "" && arr[i - 1][j] == "") {
                            arr[i - 1][j] = arr[i][j];
                            arr[i][j] = "";
                            i = arr.length - 1;
                            j = 0;
                        }
                    }
                }

                return arr;

            }
        }

        function moveLeft(arr) {
            var wasChanged = false;
            if (arr != null && arr !== undefined) {
                for (var i = 0; i < arr.length; i++) {
                    for (var j = 0; j < arr[i].length - 1; j++) {
                        if (arr[i][j] == arr[i][j + 1] && arr[i][j] != "") {
                            arr[i][j] = (arr[i][j + 1] + arr[i][j]);
                            arr[i][j + 1] = "";
                        }

                    }
                }

                for (var i = 0; i < arr.length; i++) {
                    for (var j = arr[i].length - 1; j > 0; j--) {
                        if (arr[i][j] != "" && arr[i][j - 1] == "") {
                            arr[i][j - 1] = arr[i][j];
                            arr[i][j] = "";
                            j = arr[i].length - 1;
                            i = 0;
                        }

                    }
                }
                return arr;
            }

        }

        function moveRight(arr) {

            if (arr != null && arr !== undefined) {
                for (var i = 0; i < arr.length; i++) {
                    for (var j = arr[i].length - 1; j > 0; j--) {
                        if (arr[i][j] == arr[i][j - 1] && arr[i][j] != "") {
                            arr[i][j] = (arr[i][j - 1] + arr[i][j]);
                            arr[i][j - 1] = "";
                        }

                    }
                }
                for (var i = 0; i < arr.length; i++) {

                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] != "" && arr[i][j + 1] == "") {
                            arr[i][j + 1] = arr[i][j];
                            arr[i][j] = "";
                            j = 0;
                            i = 0;
                        }
                    }
                }
                return arr;

            }
        }

        function getResult(arr) {
            if (!isPossibleToMove(arr)) {
                var max = 0;
                var resultShow = $("#Popup");

                for (var i = 0; i < arr.length; i++) {
                    for (var j = 0; j < arr[i].length; j++) {
                        if (arr[i][j] > max) {
                            max = arr[i][j];

                        }
                    }
                }
                resultShow.kendoDialog({
                    width: "450px",
                    title: "GAME OVER",
                    closable: false,
                    modal: false,
                    content: `<p>Game over. Max value is ${max}<p>`,
                    actions: [{
                            text: 'Ok'
                        }

                    ]
                });
                resultShow.data("kendoDialog").open();
            }
        }

        function isPossibleToMove(arr) {
            var isPossible = (isPossibleDownMove(arr) || isPossibleUpMove(arr) || isPossibleLeftMove(arr) || isPossibleRightMove(arr));
            return isPossible;
        }

        function isPossibleDownMove(arr) {
            var isPossible = false;
            for (var i = 0; i < arr.length - 1; i++) {
                for (var j = 0; j < arr[i].length; j++) {
                    if (arr[i + 1][j] == "" || (arr[i][j] == arr[i + 1][j])) {
                        isPossible = true;
                        return isPossible;
                    }
                }
            }
            return isPossible;
        }

        function ownTemolate(i) {
            var length = i.length;
            var t = getNumberClass(i[0]);
            var temp = kendo.template("#for(var z=0; z< qq.length;z++){#  <div class='#getNumberClass(qq[i])#'>  #=qq[z]#</div> #}# ");
            var data = {
                qq: `<b>${i}</b>`
            };
            var res = temp(data);
            return res;
        }

        function changeBackground() {
            $(this).addClass('two_hundred_fifty_six');
            return true;
        }

        function isPossibleUpMove(arr) {
            var isPossible = false;
            for (var i = arr.length - 1; i > 0; i--) {
                for (var j = 0; j < arr[i].length; j++) {
                    if (arr[i - 1][j] == "" || (arr[i][j] == arr[i - 1][j])) {
                        isPossible = true;
                        return isPossible;
                    }
                }
            }
            return isPossible;
        }
        $("#ResetBtn").click(function() {
            for (var i = 0; i < coordsValues.length; i++) {
                for (var j = 0; j < coordsValues[i].length; j++) {
                    coordsValues[i][j] = "";
                }
            }
            coordsValues[0][0] = 2;
            coordsValues[0][coordsValues[0].length - 1] = 2;
            gameGrid.dataSource.read();
            gameGrid.refresh();
        });

        function isPossibleRightMove(arr) {
            var isPossible = false;
            for (var i = 0; i < arr.length; i++) {
                for (var j = 0; j < arr[i].length - 1; j++) {
                    if (arr[i][j + 1] == "" || (arr[i][j] == arr[i][j + 1])) {
                        isPossible = true;
                        return isPossible;
                    }
                }
            }
            return isPossible;
        }

        function isPossibleLeftMove(arr) {
            var isPossible = false;
            for (var i = 0; i < arr.length; i++) {
                for (var j = arr[i].length - 1; j > 0; j--) {
                    if (arr[i][j - 1] == "" || (arr[i][j] == arr[i][j - 1])) {
                        isPossible = true;
                        return isPossible;
                    }
                }
            }
            return isPossible;
        }

        function getNumberClass(n) {
            return colorClassDict[n];
        }
    </script>
</body>

</html>